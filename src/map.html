<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å››ã®ãƒ‡ã‚¸ã‚¿ãƒ«å›³æ›¸é¤¨ãƒãƒƒãƒ—</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="js/user_manager.js"></script>
    <style>
        :root {
            --primary-color: #0074D9; /* æ±äº¬å¤§å­¦ã®ã‚¹ã‚¯ãƒ¼ãƒ«ã‚«ãƒ©ãƒ¼ã«è¿‘ã„é’ */
            --secondary-color: #2ECC40; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
            --background-light: #F0F2F5;
            --card-bg: #FFFFFF;
            --text-color: #333;
            --heading-color: #0A192F;
            --sub-text-color: #777;
            --shadow-light: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-medium: 0 8px 30px rgba(0,0,0,0.1);

            /* JavaScriptã‹ã‚‰å‹•çš„ã«è¨­å®šã•ã‚Œã‚‹RGBå€¤ã®ãŸã‚ã®å¤‰æ•° */
            --primary-color-rgb: 0, 116, 217; /* --primary-colorã®RGBå€¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
            --secondary-color-rgb: 46, 204, 64; /* --secondary-colorã®RGBå€¤ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) */
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background-light), #e0e6ed); /* å¾®å¦™ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: flex-start;
            align-items: center;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Global Header --- */
        .global-header {
            width: 100%;
            background-color: var(--card-bg);
            padding: 20px 0;
            box-shadow: var(--shadow-light);
            text-align: center;
            z-index: 20;
            position: relative;
        }
        .global-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin: 0;
            letter-spacing: -1px;
        }
        .global-header p {
            font-size: 0.95rem;
            color: var(--sub-text-color);
            margin-top: 5px;
        }

        /* --- User Selection Header --- */
        .user-header {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-selector label {
            font-size: 0.9rem;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .user-dropdown {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .user-dropdown:hover, .user-dropdown:focus {
            border-color: var(--primary-color);
            outline: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(var(--primary-color-rgb), 0.2);
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            margin-left: 10px;
        }

        /* --- Map Container --- */
        .map-container {
            position: relative;
            width: 90vw;
            height: calc(100vh - 120px);
            max-width: 1400px;
            max-height: 900px;
            margin: 20px auto;
            background: url('https://via.placeholder.com/1400x900/E8F5FF/D4EEFF?text=Tokyo+Knowledge+Network+Map') no-repeat center center / cover; /* åœ°å›³ã®ãƒ™ãƒ¼ã‚¹èƒŒæ™¯ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã« */
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            animation: fadeInMap 1.5s ease-out forwards;
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* --- Point (Common Styles for all clickable points: Library and Hub) --- */
        .point {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 10; /* SVGç·šã‚ˆã‚Šæ‰‹å‰ã« */
            cursor: pointer;
        }

        .point:hover {
            transform: scale(1.08) translateY(-15px);
            z-index: 15;
            box-shadow: 0 10px 30px rgba(var(--primary-color-rgb), 0.3);
        }

        .point img {
            width: 160px;
            height: auto;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            border: 3px solid transparent;
        }

        .point:hover img {
            transform: translateY(-8px);
            border-color: var(--primary-color);
        }

        .point .label {
            background-color: rgba(255, 255, 255, 0.95);
            color: var(--primary-color);
            padding: 10px 18px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 15px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .point:hover .label {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.3);
        }

        /* å„å›³æ›¸é¤¨ã®ä½ç½®è¨­å®š (map-containerã«å¯¾ã™ã‚‹ç›¸å¯¾çš„ãªä½ç½®) */
        /* æ­£ä¸‰è§’å½¢ã®é ‚ç‚¹ã¨ã—ã¦é…ç½® */
        #hongo-point { top: 20%; left: 50%; transform: translateX(-50%); } /* ä¸Šä¸­å¤® */
        #komaba-point { top: 80%; left: 20%; } /* å·¦ä¸‹ */
        #kashiwa-point { top: 80%; left: 80%; } /* å³ä¸‹ */

        /* ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ–å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ—¢å­˜ã®.pointã¨çµ„ã¿åˆã‚ã›ï¼‰ */
        .digital-hub-point {
            top: 50%; /* æ­£ä¸‰è§’å½¢ã®é‡å¿ƒã«é…ç½® */
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .digital-hub-point:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        .digital-hub-point .hub-icon {
            font-size: 4rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            animation: pulse 1.5s infinite alternate;
        }
        .digital-hub-point .label {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-medium);
        }
        @keyframes pulse {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.05); opacity: 1; }
        }

        /* --- Info Panel --- */
        .info-panel {
            position: absolute;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            width: 350px;
            max-height: 80%;
            overflow-y: auto;
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: fadeInPanel 0.4s ease-out;
        }

        .info-panel.active {
            display: flex;
        }

        .info-panel h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--background-light);
            padding-bottom: 10px;
        }

        .info-panel p {
            font-size: 0.95rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .info-panel .features-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .info-panel .features-list li {
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .info-panel .features-list li::before {
            content: 'âœ…';
            margin-right: 8px;
        }

        .info-panel .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--sub-text-color);
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 15px;
            transition: color 0.3s ease;
        }
        .info-panel .close-btn:hover {
            color: var(--primary-color);
        }

        .info-panel .access-button {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 25px;
            transition: background 0.3s ease, transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .info-panel .access-button:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        /* --- SVG Lines --- */
        .map-svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* ãƒã‚¤ãƒ³ãƒˆã®ä¸‹ã€ãƒãƒƒãƒ—èƒŒæ™¯ã®ä¸Š */
            pointer-events: none; /* SVGãŒã‚¯ãƒªãƒƒã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã« */
        }
        .map-line {
            stroke: rgba(var(--primary-color-rgb), 0.3); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç·šã®è‰² */
            stroke-width: 3;
            fill: none;
            transition: stroke 0.5s ease, stroke-width 0.5s ease;
            filter: drop-shadow(0 0 2px rgba(var(--primary-color-rgb), 0.1)); /* ç·šã®å½± */
        }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆJavaScriptã§ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ï¼‰ */
        .map-line.active {
            stroke: url(#line-gradient); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ */
            stroke-width: 5;
            filter: drop-shadow(0 0 8px rgba(var(--primary-color-rgb), 0.7)); /* å¼·ãå…‰ã‚‹å½± */
            animation: dashFlow 3s linear infinite; /* ç‚¹ç·šãŒæµã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        @keyframes dashFlow {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 60; }
        }

        /* --- Animations --- */
        @keyframes fadeInMap {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInPanel {
            from { opacity: 0; transform: translate(-50%, -40%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 900px) {
            .global-header h1 { font-size: 2rem; }
            .global-header p { font-size: 0.85rem; }
            .map-container {
                width: 95vw;
                height: calc(100vh - 100px);
                margin-top: 15px;
            }
            .point img { width: 120px; border-radius: 15px; }
            .point .label { font-size: 0.85rem; padding: 8px 15px; margin-top: 10px; }

            /* å„è¦ç´ ã®ä½ç½®è¨­å®šã‚’èª¿æ•´ */
            #hongo-point { top: 15%; left: 50%; }
            #komaba-point { top: 85%; left: 15%; }
            #kashiwa-point { top: 85%; left: 85%; }
            #digital-hub { top: 50%; left: 50%; }

            .info-panel {
                width: 300px;
                padding: 25px;
            }
            .info-panel h3 { font-size: 1.6rem; }
            .info-panel p { font-size: 0.85rem; }
            .info-panel .features-list li { font-size: 0.8rem; }
        }

        @media (max-width: 600px) {
            .global-header { padding: 15px 0; }
            .global-header h1 { font-size: 1.8rem; }
            .map-container {
                width: 98vw;
                height: calc(100vh - 80px);
                margin-top: 10px;
                border-radius: 10px;
            }
            .point img { width: 90px; border-radius: 10px; }
            .point .label { font-size: 0.75rem; padding: 6px 12px; margin-top: 8px; }

            /* å„è¦ç´ ã®ä½ç½®è¨­å®šã‚’ã•ã‚‰ã«èª¿æ•´ */
            #hongo-point { top: 10%; left: 50%; }
            #komaba-point { top: 90%; left: 15%; }
            #kashiwa-point { top: 90%; left: 85%; }
            #digital-hub { top: 50%; left: 50%; }

            .info-panel {
                width: 90%;
                max-height: 90%;
                padding: 20px;
            }
            .info-panel h3 { font-size: 1.4rem; }
            .info-panel .close-btn { font-size: 1.5rem; top: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    <header class="global-header">
        <h1>ç¬¬å››ã®ãƒ‡ã‚¸ã‚¿ãƒ«å›³æ›¸é¤¨ãƒãƒƒãƒ—</h1>
        <p>æ±äº¬å¤§å­¦ã®çŸ¥ã®æ‹ ç‚¹ã‚’ãƒ‡ã‚¸ã‚¿ãƒ«ã§ç¹‹ã</p>
    </header>

    <div class="user-header">
        <div class="user-selector">
            <label for="user-select">ãƒ¦ãƒ¼ã‚¶ãƒ¼:</label>
            <select id="user-select" class="user-dropdown" onchange="switchUser()">
                <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                <option value="yohei">Yohei Sawada (å‡†æ•™æˆ)</option>
                <option value="amane">Amane Kubo (M2å­¦ç”Ÿ)</option>
            </select>
            <img id="user-avatar" src="https://via.placeholder.com/30x30" alt="User Avatar" class="user-avatar">
        </div>
    </div>

    <div class="map-container">
        <svg class="map-svg-overlay" viewBox="0 0 1400 900">
            <defs>
                <linearGradient id="line-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="var(--primary-color)" />
                    <stop offset="100%" stop-color="var(--secondary-color)" />
                </linearGradient>
            </defs>

            <path id="svg-conn-hub-hongo" class="map-line"></path>
            <path id="svg-conn-hub-komaba" class="map-line"></path>
            <path id="svg-conn-hub-kashiwa" class="map-line"></path>

            <path id="svg-conn-hongo-komaba" class="map-line"></path>
            <path id="svg-conn-hongo-kashiwa" class="map-line"></path>
            <path id="svg-conn-komaba-kashiwa" class="map-line"></path>
        </svg>

        <a href="javascript:void(0);" class="point" id="hongo-point" data-point-type="library" data-id="hongo">
            <img src="https://via.placeholder.com/160x160/FFDDC1/FF8C00?text=Hongo+Library" alt="æœ¬éƒ·å›³æ›¸é¤¨ã®ã‚¤ãƒ©ã‚¹ãƒˆ">
            <span class="label">æœ¬éƒ·å›³æ›¸é¤¨</span>
        </a>

        <a href="javascript:void(0);" class="point" id="komaba-point" data-point-type="library" data-id="komaba">
            <img src="https://via.placeholder.com/160x160/FFEBEB/FFC1C1?text=Komaba+Library" alt="é§’å ´å›³æ›¸é¤¨ã®ã‚¤ãƒ©ã‚¹ãƒˆ">
            <span class="label">é§’å ´å›³æ›¸é¤¨</span>
        </a>

        <a href="javascript:void(0);" class="point" id="kashiwa-point" data-point-type="library" data-id="kashiwa">
            <img src="https://via.placeholder.com/160x160/D1E9FF/A3D4FF?text=Kashiwa+Library" alt="æŸå›³æ›¸é¤¨ã®ã‚¤ãƒ©ã‚¹ãƒˆ">
            <span class="label">æŸå›³æ›¸é¤¨</span>
        </a>

        <a href="javascript:void(0);" class="point digital-hub-point" id="digital-hub" data-point-type="hub" data-id="core">
            <div class="hub-icon">ğŸŒ</div>
            <span class="label">ãƒ‡ã‚¸ã‚¿ãƒ«ä¸­æ ¸ãƒãƒ–</span>
        </a>

        <div class="info-panel" id="library-info-panel">
            <button class="close-btn">&times;</button>
            <h3 id="panel-title"></h3>
            <p id="panel-description"></p>
            <ul class="features-list" id="panel-features">
                </ul>
            <a href="#" class="access-button" id="panel-access-button">è©³ç´°ã¸ã‚¢ã‚¯ã‚»ã‚¹</a>
        </div>
    </div>

    <script>
        // å„è¦ç´ ã®ãƒ‡ãƒ¼ã‚¿å®šç¾©
        const dataMap = {
            library: {
                hongo: {
                    title: 'æœ¬éƒ·å›³æ›¸é¤¨',
                    description: 'æ­´å²ã¨ä¼çµ±ã‚’èª‡ã‚‹æœ¬éƒ·ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®ä¸­å¿ƒå›³æ›¸é¤¨ã€‚äººæ–‡ãƒ»ç¤¾ä¼šãƒ»è‡ªç„¶ç§‘å­¦ã®å¹…åºƒã„åˆ†é‡ã«ã‚ãŸã‚‹è†¨å¤§ãªè”µæ›¸ã‚’èª‡ã‚Šã€ç ”ç©¶è€…ã¨å­¦ç”Ÿã®æ·±ã„å­¦ã³ã‚’æ”¯ãˆã¾ã™ã€‚è²´é‡ãªå¤å…¸ç±ã‹ã‚‰æœ€æ–°ã®å­¦è¡“é›‘èªŒã¾ã§ã€çŸ¥ã®å®åº«ã§ã™ã€‚',
                    features: ['è²´é‡æ›¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³', 'ç ”ç©¶å€‹å®¤åˆ©ç”¨', 'ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', 'ãƒ¬ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚µãƒ¼ãƒ“ã‚¹'],
                    link: '#hongo-digital-library'
                },
                komaba: {
                    title: 'é§’å ´å›³æ›¸é¤¨',
                    description: 'æ•™é¤Šæ•™è‚²ã®ä¸­å¿ƒã‚’æ‹…ã†é§’å ´ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®å›³æ›¸é¤¨ã€‚å¤šæ§˜ãªå­¦å•åˆ†é‡ã®åŸºç¤ã‚’å­¦ã¶ãŸã‚ã®è³‡æ–™ãŒå……å®Ÿã—ã€ã‚°ãƒ«ãƒ¼ãƒ—å­¦ç¿’ã‚¹ãƒšãƒ¼ã‚¹ã‚„ãƒ¡ãƒ‡ã‚£ã‚¢ã‚»ãƒ³ã‚¿ãƒ¼ãªã©ã€å­¦ç”Ÿã®ä¸»ä½“çš„ãªå­¦ã³ã‚’ä¿ƒã™ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªç’°å¢ƒãŒç‰¹å¾´ã§ã™ã€‚',
                    features: ['è‡ªå­¦è‡ªç¿’ã‚¹ãƒšãƒ¼ã‚¹', 'ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚³ãƒ¢ãƒ³ã‚º', 'æƒ…å ±ãƒªãƒ†ãƒ©ã‚·ãƒ¼æ•™è‚²', 'DVDãƒ»AVè³‡æ–™'],
                    link: '#komaba-digital-library'
                },
                kashiwa: {
                    title: 'æŸå›³æ›¸é¤¨',
                    description: 'æœ€å…ˆç«¯ã®ç ”ç©¶æ‹ ç‚¹ã§ã‚ã‚‹æŸã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã«ä½ç½®ã™ã‚‹ã€æœªæ¥å¿—å‘ã®å›³æ›¸é¤¨ã€‚ç”Ÿå‘½ç§‘å­¦ã€ç’°å¢ƒç§‘å­¦ã€æƒ…å ±ç§‘å­¦ãªã©ã€ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢åˆ†é‡ã®å°‚é–€è³‡æ–™ã‚’è±Šå¯Œã«å–ã‚Šæƒãˆã€å›½éš›çš„ãªç ”ç©¶æ´»å‹•ã‚’å¼·åŠ›ã«ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚',
                    features: ['é›»å­ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç‰¹åŒ–', 'ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ”¯æ´', 'ã‚ªãƒ¼ãƒ—ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ä¿ƒé€²', 'å…±åŒç ”ç©¶ã‚¹ãƒšãƒ¼ã‚¹'],
                    link: '#kashiwa-digital-library'
                }
            },
            hub: {
                core: {
                    title: 'ãƒ‡ã‚¸ã‚¿ãƒ«ä¸­æ ¸ãƒãƒ–',
                    description: 'ã€Œç¬¬å››ã®ãƒ‡ã‚¸ã‚¿ãƒ«å›³æ›¸é¤¨ã€ã®å¿ƒè‡“éƒ¨ã€‚ã‚ãªãŸã®å­¦ç¿’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã€Œç§ã®å›³æ›¸é¤¨ã€ã‚„ã€AIã«ã‚ˆã‚‹ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«é¸æ›¸ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãªã©ã€ç”Ÿæ¶¯å­¦ç¿’ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹æœ€å…ˆç«¯æ©Ÿèƒ½ãŒé›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚',
                    features: ['ãƒã‚¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé€£æº', 'AIé¸æ›¸ãƒ»ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', 'ç”Ÿæ¶¯å­¦ç¿’ãƒ‘ã‚¹ææ¡ˆ', 'çµ±åˆæ¤œç´¢ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ '],
                    link: '#my-library-core'
                }
            }
        };

        const clickablePoints = document.querySelectorAll('.point'); // å…¨ã¦ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ 
        const infoPanel = document.getElementById('library-info-panel');
        const closeBtn = infoPanel.querySelector('.close-btn');
        const panelTitle = document.getElementById('panel-title');
        const panelDescription = document.getElementById('panel-description');
        const panelFeatures = document.getElementById('panel-features');
        const panelAccessButton = document.getElementById('panel-access-button');

        // SVGãƒ©ã‚¤ãƒ³è¦ç´ ã®å–å¾—
        const svgLines = {
            hubHongo: document.getElementById('svg-conn-hub-hongo'),
            hubKomaba: document.getElementById('svg-conn-hub-komaba'),
            hubKashiwa: document.getElementById('svg-conn-hub-kashiwa'),
            // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸå›³æ›¸é¤¨é–“ã®ç·š
            hongoKomaba: document.getElementById('svg-conn-hongo-komaba'),
            hongoKashiwa: document.getElementById('svg-conn-hongo-kashiwa'),
            komabaKashiwa: document.getElementById('svg-conn-komaba-kashiwa')
        };

        // å„ãƒã‚¤ãƒ³ãƒˆã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (SVGã®åº§æ¨™ç³»ã«åˆã‚ã›ã‚‹)
        function getPointCenter(element) {
            const rect = element.getBoundingClientRect();
            const mapRect = document.querySelector('.map-container').getBoundingClientRect();
            const centerX = (rect.left + rect.right) / 2 - mapRect.left;
            const centerY = (rect.top + rect.bottom) / 2 - mapRect.top;

            // map-containerã®æœ€å¤§å¹…/é«˜ã•ï¼ˆ1400x900ï¼‰ã«æ­£è¦åŒ–
            const normalizedX = (centerX / mapRect.width) * 1400;
            const normalizedY = (centerY / mapRect.height) * 900;
            return { x: normalizedX, y: normalizedY };
        }

        // SVGãƒ‘ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateSvgPaths() {
            const hongoCenter = getPointCenter(document.getElementById('hongo-point'));
            const komabaCenter = getPointCenter(document.getElementById('komaba-point'));
            const kashiwaCenter = getPointCenter(document.getElementById('kashiwa-point'));
            const hubCenter = getPointCenter(document.getElementById('digital-hub'));

            // ãƒãƒ–ã¨å„å›³æ›¸é¤¨ã‚’çµã¶ç·š
            svgLines.hubHongo.setAttribute('d', `M${hubCenter.x} ${hubCenter.y} L${hongoCenter.x} ${hongoCenter.y}`);
            svgLines.hubKomaba.setAttribute('d', `M${hubCenter.x} ${hubCenter.y} L${komabaCenter.x} ${komabaCenter.y}`);
            svgLines.hubKashiwa.setAttribute('d', `M${hubCenter.x} ${hubCenter.y} L${kashiwaCenter.x} ${kashiwaCenter.y}`);

            // ï¼“ã¤ã®å›³æ›¸é¤¨ã‚’çµã¶ç·š
            svgLines.hongoKomaba.setAttribute('d', `M${hongoCenter.x} ${hongoCenter.y} L${komabaCenter.x} ${komabaCenter.y}`);
            svgLines.hongoKashiwa.setAttribute('d', `M${hongoCenter.x} ${hongoCenter.y} L${kashiwaCenter.x} ${kashiwaCenter.y}`);
            svgLines.komabaKashiwa.setAttribute('d', `M${komabaCenter.x} ${komabaCenter.y} L${kashiwaCenter.x} ${kashiwaCenter.y}`);
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚ãƒ‘ã‚¹ã‚’æ›´æ–°
        window.addEventListener('resize', updateSvgPaths);
        // DOMContentLoadedæ™‚ã«ã‚‚æ›´æ–°
        document.addEventListener('DOMContentLoaded', updateSvgPaths);


        // HEX to RGB for dynamic CSS variables
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `${r}, ${g}, ${b}`;
        }

        // Set initial primary/secondary color RGB for CSS variables
        document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()));
        document.documentElement.style.setProperty('--secondary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()));


        clickablePoints.forEach(point => {
            point.addEventListener('click', (e) => {
                e.preventDefault();
                const pointType = point.dataset.pointType;
                const pointId = point.dataset.id;
                
                const data = dataMap[pointType][pointId];

                panelTitle.textContent = data.title;
                panelDescription.textContent = data.description;
                
                panelFeatures.innerHTML = '';
                data.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.textContent = feature;
                    panelFeatures.appendChild(li);
                });
                
                panelAccessButton.href = data.link;
                
                infoPanel.classList.add('active');
            });
        });

        closeBtn.addEventListener('click', () => {
            infoPanel.classList.remove('active');
        });

        // Click outside panel to close it
        document.body.addEventListener('click', (e) => {
            if (infoPanel.classList.contains('active') && !infoPanel.contains(e.target) && !e.target.closest('.point')) {
                infoPanel.classList.remove('active');
            }
        });

        // ã‚¢ã‚¯ã‚»ã‚¹é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç·šã®å…‰ã‚Šå…·åˆåˆ¶å¾¡
        const accessLevels = {
            'svg-conn-hub-hongo': 0.8,
            'svg-conn-hub-komaba': 0.6,
            'svg-conn-hub-kashiwa': 0.7,
            'svg-conn-hongo-komaba': 0.5, // å›³æ›¸é¤¨é–“ã®ç·šã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ 
            'svg-conn-hongo-kashiwa': 0.9,
            'svg-conn-komaba-kashiwa': 0.4
        };

        function updateLineActivity() {
            // svgLinesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®å…¨ã¦ã®ç·šã‚’ãƒ«ãƒ¼ãƒ—
            for (const lineId in svgLines) {
                const lineElement = svgLines[lineId];
                if (!lineElement) continue; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                let currentAccess = accessLevels[lineId] + (Math.random() * 0.4 - 0.2); // -0.2 to +0.2 ã®ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•
                currentAccess = Math.max(0.1, Math.min(1.0, currentAccess)); // 0.1ã‹ã‚‰1.0ã®ç¯„å›²ã«ã‚¯ãƒ©ãƒ³ãƒ—
                accessLevels[lineId] = currentAccess; // æ¬¡ã®æ›´æ–°ã®ãŸã‚ã«ä¿å­˜

                if (currentAccess > 0.5) { // ã‚ã‚‹ç¨‹åº¦ã®ã‚¢ã‚¯ã‚»ã‚¹é‡ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹é–¾å€¤
                    lineElement.classList.add('active');
                } else {
                    lineElement.classList.remove('active');
                }
            }
        }

        // ä¸€å®šé–“éš”ã§ç·šã®æ´»å‹•çŠ¶æ³ã‚’æ›´æ–°
        setInterval(updateLineActivity, 2000); // 2ç§’ã”ã¨ã«æ›´æ–°

        // åˆæœŸãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒªã‚¬ãƒ¼ã¨SVGãƒ‘ã‚¹ã®æ›´æ–°
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.map-container').style.opacity = 1;
            document.querySelector('.map-container').style.transform = 'scale(1)';
            updateSvgPaths(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«SVGãƒ‘ã‚¹ã‚’æ­£ç¢ºã«æç”»
            updateLineActivity(); // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚ä¸€åº¦æ›´æ–°
        });
        
        // User switching functionality
        function switchUser() {
            const userSelect = document.getElementById('user-select');
            const userAvatar = document.getElementById('user-avatar');
            const selectedUser = userSelect.value;
            
            // Update avatar and redirect to appropriate page
            switch(selectedUser) {
                case 'yohei':
                    userAvatar.src = 'https://www.u-tokyo.ac.jp/content/400002137.jpg';
                    window.location.href = 'mypage.html';
                    break;
                case 'amane':
                    userAvatar.src = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=300&h=300&fit=crop&crop=face';
                    window.location.href = 'mypage_amane.html';
                    break;
                default:
                    userAvatar.src = 'https://via.placeholder.com/30x30';
                    break;
            }
        }

        // Initialize avatar on page load
        document.addEventListener('DOMContentLoaded', function() {
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) {
                userAvatar.src = 'https://via.placeholder.com/30x30';
            }
        });
    </script>
</body>
</html>